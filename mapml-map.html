<link rel="import" href="./bower_components/polymer/polymer.html">
<link rel="import" href="mapml-layer.html">

<script src="scripts/lib/leaflet-src.js"></script>
<script src="scripts/lib/proj4-compressed.js"></script>
<script src="scripts/lib/proj4leaflet.js"></script>
<script src="scripts/mapml.js"></script>
<script src="scripts/URI.js"></script>


<dom-module id="mapml-map">
  <!-- in polymer 1.0.x, styles must be outside of the <template> element
       https://www.polymer-project.org/1.0/docs/migration.html#local-dom-template -->
  <style>
   :host {
     display: inline-block;
     position: relative;
   }

   #map:focus {
     outline: 2px  double lightskyblue;
   }
     

  </style>
  <link rel="stylesheet" href="scripts/lib/leaflet.css" />

<template>
  <!-- giving the map div a tabindex allows the map to display its focus. -->
  <!-- see the #map:focus selector in styles, above. -->
  <div id="map" tabindex="0"></div>
  <content></content>
</template>
<script>
Polymer({
    is: "mapml-map",
    extends : "map",
    properties: {
      lat : {
        type: Number,
        value: 0,
        reflectToAttribute: true
      },
      lon : {
        type: Number,
        value: 0,
        reflectToAttribute: true
      },
      zoom : {
        type: Number,
        value: 0,
        reflectToAttribute: true
      },
      projection: {
        type: String,
        value: "OSMTILE",
        reflectToAttribute: false
      },
      width: {
        type: Number,
        value: null,
        reflectToAttribute: true
      },
      height: {
        type: Number,
        value: null,
        reflectToAttribute: true
      },
      layers: {
        type: Object,
        value: function () {
          return this.getElementsByTagName('source');
        }
      }
    },
    observers: [
      '_widthChanged(width)','_heightChanged(height)'
    ],
    _widthChanged: function(width) {
        this.style.width = width+"px";
        this.$.map.style.width = width+"px";
        if (this.map) {
            this.map.invalidateSize(false);
        }
    },
    _heightChanged: function(height) {
        this.style.height = height+"px";
        this.$.map.style.height = height+"px";
        if (this.map) {
            this.map.invalidateSize(false);
        }
    },
    zoomTo: function(lat, lon, zoom) {
        zoom = zoom||this.zoom;
        var location = new L.LatLng(lat,lon);
        this.map.setView(location, zoom);
        this.zoom = zoom;
        this.lat = location.lat;
        this.lon = location.lng;
    },
    _onMapMoveEnd: function() {
        // remember to tell Leaflet event handler that 'this' refers to something other than the map
        // in this case the custom polymer element
        this.lat = this.map.getCenter().lat;
        this.lon = this.map.getCenter().lng;
        this.zoom = this.map.getZoom();
    },
    attached: function() {
      /* needs a delay to provide setup time for polymer */
      this.async( function () {
        console.log(this.localName + '#' + this.id + ' was attached');
        // at this point, Polymer has set up the map-layer elements, if any
        // so their API can be used to set properties on them that they'll need
        // the map-layer elements which were children of the map is="mapml-map"
        // element should still be, based on the content element in the template
        // above.
        for (var i = 0,controls = {};i < this.layers.length;i++) {
         /* 
          * Explicitly set the z-index for all layers based on their document order. 
          * Note that zIndex has no effect on vector layers, as they are managed
          * separately by Leaflet.
          *
          * Set the opacity based on the CSS property calculated for the element
          */
          L.setOptions(this.layers[i]._layer, {zIndex: i+1, opacity: window.getComputedStyle(this.layers[i]).opacity});
          controls[this.layers[i].label] = this.layers[i]._layer;
        }
        
        // the dimension attributes win, if they're there. A map does not
        // have an intrinsic size, unlike an image or video, and so must 
        // have a defined width and height.
        var s = window.getComputedStyle(this),
        w = s.width, h=s.height;
        
        if (!this.width) {
          this.$.map.style.width = w;
          this.width = parseInt(w.replace('px',''));
        } else {
          this.$.map.style.width = this.width+"px";
        }
        
        if (!this.height) {
          this.$.map.style.height = h;
          this.height = parseInt(h.replace('px',''));
        } else {
          this.$.map.style.height = this.height+"px";
        }
        this.map = L.map(this.$.map, {
          center: new L.LatLng(this.lat, this.lon),
          projection: this.projection,
          crs: M[this.projection],
          zoom: this.zoom,
          layers: [].slice.call(this.layers).filter(checked).map(layerProp)
        });
        // reflect user or script-initiated map movements to lat, lon, zoom attributes
        this.map.on('moveend', this._onMapMoveEnd, this);
        this._layerControl = M.mapMlLayerControl(controls).addTo(this.map);
        this._attributionControl =  this.map.attributionControl.setPrefix('<a href="https://www.w3.org/community/maps4html/" title="W3C Maps4HTML Community Group">MapML</a>');
        // make sure the layer knows about the map it belongs to.
        for (var i = 0;i < this.layers.length;i++) {
          this.layers[i]._layer._map = this.map;
        }
        function checked(element, index, array) {
            return element.checked;
        };
        function disabled(element, index, array) {
            return element.disabled;
        };
        function layerProp(element, index, array) {
          return element._layer;
        };

        console.log("map center: "+this.map.getCenter());
        var west = this.map.getBounds().getWest(),
            south = this.map.getBounds().getSouth(),
            east = this.map.getBounds().getEast(),
            north = this.map.getBounds().getNorth();

        if (west === east || south === north) {
          console.log('ERROR: BAD EXTENT');
        }
        console.log("map bounds bbox=" + this.map.getBounds().toBBoxString());
      },10);
    }
});
</script>
</dom-module>
