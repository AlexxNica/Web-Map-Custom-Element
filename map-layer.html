<link rel="import" href="./bower_components/polymer/polymer.html">

<script src="scripts/lib/leaflet-src.js"></script>
<script src="scripts/lib/proj4-compressed.js"></script>
<script src="scripts/lib/proj4leaflet.js"></script>
<script src="scripts/mapml.js"></script>
<script src="scripts/URI.js"></script>

<dom-module id="map-layer">
  <!-- in polymer 1.0.x, styles must be outside of the <template> element
       https://www.polymer-project.org/1.0/docs/migration.html#local-dom-template -->
  <style>
   :host {
     display: none;
   }
  </style>

<script>
MapLayer = Polymer({
    is: "map-layer",
    factoryImpl: function(src, label, checked, hidden) {
      this.src = src;
      this.label = label||this.label;
      this.checked = checked||this.checked;
      this.hidden = hidden||this.hidden;
    },
    properties: {
      src : {
        type: String,
        reflectToAttribute: true
      },
      label : {
        type: String,
        value: 'Layer',
        reflectToAttribute: true,
        observer: '_labelChanged'
      },
      // changing checked turns the layer on or off, and reflects that in the
      // user interface/ layer control.
      checked: {
        type: Boolean,
        reflectToAttribute: true,
        observer: '_toggleChecked'
      },
      // changing disabled does nothing; it is supposed to be read-only to the api,
      // and indicates if the layer is visible, i.e. if turned on it would be in
      // the map extent / zoom bounds of the map and will be updated on zoom/pan
      // by the map.  If a layer is disabled, it is 'greyed out' in the layer control
      // and can't be clicked on, although it can still be checked/unchecked via the api.
      disabled: {
        type: Boolean,
        reflectToAttribute: true
      },
      // hidden allows a layer to be added to the map but not displayed in the
      // layer control.  Changing hidden removes/adds it to the layer control,
      // but does not change the status of the layer on the map. It is 'hidden'
      // from the user interface.
      hidden: {
        type: Boolean,
        reflectToAttribute: true,
        observer: '_toggleHidden'
      }
    },
    _labelChanged: function() {
        var map = this.parentElement && this.parentElement.map;
        if (map) {
          this._toggleHidden(false);
        }
    },
    _apiToggleChecked: true,
    _toggleChecked: function() {
        var map = this.parentElement && this.parentElement.map;
        if (map) {
          if (this._apiToggleChecked) {
            if (map.hasLayer(this._layer)) {
              map.removeLayer(this._layer);
            } else {
              map.addLayer(this._layer);
            }
            map.fire('moveend');
          }
          this._apiToggleChecked = true;
        }
    },
    _onMapMoveEnd: function () {
        var layer = this._layer, map = layer._map;
        if (map) {
            var zoomBounds = layer.getZoomBounds(), zoom = map.getZoom(), 
            withinZoomBounds = (zoomBounds && zoomBounds.min <= zoom && zoom <= zoomBounds.max),
            projectionMatches = layer._projectionMatches(map),
            visible = projectionMatches && withinZoomBounds && map.getPixelBounds().intersects(layer.getLayerExtentBounds(map));
            this.disabled = !visible;
        }
    },
    _onLayerChange: function() {
       if (this._layer._map) {
          // can't disable observers, have to set a flag telling it where
          // the 'event' comes from: either the api or a user click/tap
          this._apiToggleChecked = false;
          this.checked = this._layer._map.hasLayer(this._layer);
       }
    },
    _toggleHidden: function(hide) {
        var map = this.parentElement.map;
        if (map && this.parentElement.controls) {
            if (hide) {
                this.parentElement._layerControl.removeLayer(this._layer);
            } else {
                this.parentElement._layerControl.addOverlay(this._layer,this.label);
            }
            map.fire('moveend');
        }
    },
    attached: function() {
        console.log(this.localName + '#' + this.id + ' is attached');

        this._layer = M.mapMLLayer(this.src);

    }
});
</script>
</dom-module>
