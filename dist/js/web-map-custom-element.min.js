/*! web-map-custom-element 17-06-2016 */
function URI(a){a||(a="");var b=/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/,c=a.match(b);this.scheme=c[1]||null,this.authority=c[2]||null,this.path=c[3]||null,this.query=c[4]||null,this.fragment=c[5]||null}URI.prototype.toString=function(){var a="";return this.scheme&&(a+=this.scheme+":"),this.authority&&(a+="//"+this.authority),this.path&&(a+=this.path),this.query&&(a+="?"+this.query),this.fragment&&(a+="#"+this.fragment),a},function(){function a(a,b){var c=/^(.*)\//;return a.authority&&!a.path?"/"+b:a.path.match(c)[0]+b}function b(a){if(!a)return"";var b=a.replace(/\/\.\//g,"/");for(b=b.replace(/\/\.$/,"/");b.match(c);)b=b.replace(c,"/");for(b=b.replace(/\/([^\/]*)\/\.\.$/,"/");b.match(/\/\.\.\//);)b=b.replace(/\/\.\.\//,"/");return b}var c=/\/((?!\.\.\/)[^\/]*)\/\.\.\//;URI.prototype.resolve=function(c){var d=new URI;return this.scheme?(d.scheme=this.scheme,d.authority=this.authority,d.path=b(this.path),d.query=this.query):(this.authority?(d.authority=this.authority,d.path=b(this.path),d.query=this.query):(this.path?("/"===this.path.charAt(0)?d.path=b(this.path):(d.path=a(c,this.path),d.path=b(d.path)),d.query=this.query):(d.path=c.path,this.query?d.query=this.query:d.query=c.query),d.authority=c.authority),d.scheme=c.scheme),d.fragment=this.fragment,d}}(),function(a,b,c){var d={};a.M=d,function(){d.mime="text/mapml",d.CBMTILE=new L.Proj.CRS("EPSG:3978","+proj=lcc +lat_1=49 +lat_2=77 +lat_0=49 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs",{resolutions:[38364.660062653464,22489.62831258996,13229.193125052918,7937.5158750317505,4630.2175937685215,2645.8386250105837,1587.5031750063501,926.0435187537042,529.1677250021168,317.50063500127004,185.20870375074085,111.12522225044451,66.1459656252646,38.36466006265346,22.48962831258996,13.229193125052918,7.9375158750317505,4.6302175937685215,2.6458386250105836,1.5875031750063502],origin:[-34655800,3931e4]}),d.APSTILE=new L.Proj.CRS("EPSG:5936","+proj=stere +lat_0=90 +lat_ts=50 +lon_0=-150 +k=0.994 +x_0=2000000 +y_0=2000000 +datum=WGS84 +units=m +no_defs",{resolutions:[238810.813354,119405.406677,59702.7033384999,29851.3516692501,14925.675834625,7462.83791731252,3731.41895865639,1865.70947932806,932.854739664032,466.427369832148,233.213684916074,116.606842458037,58.3034212288862,29.1517106145754,14.5758553072877,7.28792765351156,3.64396382688807,1.82198191331174,.910990956788164,.45549547826179],origin:[-28567784.109255,32567784.109255]}),d.OSMTILE=L.CRS.EPSG3857}(),d.Util={coordsToArray:function(a){for(var b=1,c=[],d=a.split(",");b<d.length;b+=2)c.push([parseInt(d[b-1]),parseInt(d[b])]);return c}},d.coordsToArray=d.Util.coordsToArray,d.ImageOverlay=L.ImageOverlay.extend({initialize:function(a,b,c,d,e,f){this._container=e,this._url=a,this._location=b,this._size=L.point(c),this._angle=d,L.setOptions(this,f)},getEvents:function(){var a={viewreset:this._reset};return this._zoomAnimated&&(a.zoomanim=this._animateZoom),a},onAdd:function(){this._image||(this._initImage(),this.options.opacity<1&&this._updateOpacity()),this.options.interactive&&(L.DomUtil.addClass(this._image,"leaflet-interactive"),this.addInteractiveTarget(this._image)),this._container.appendChild(this._image),this._reset()},onRemove:function(){L.DomUtil.remove(this._image),this.options.interactive&&this.removeInteractiveTarget(this._image)},_animateZoom:function(a){var b=this._map.getZoomScale(a.zoom),c=this._map.getPixelOrigin().add(this._location).multiplyBy(b).subtract(this._map._getNewPixelOrigin(a.center,a.zoom)).round();L.Browser.any3d?L.DomUtil.setTransform(this._image,c,b):L.DomUtil.setPosition(this._image,c)},_reset:function(){var a=this._image,b=this._location,c=this._size;L.DomUtil.setPosition(a,b),a.style.width=c.x+"px",a.style.height=c.y+"px"}}),d.imageOverlay=function(a,b,c,e,f,g){return new d.ImageOverlay(a,b,c,e,f,g)},d.MapMLLayer=L.Layer.extend({options:{maxNext:10,zIndex:0},initialize:function(a,b){this._href=a,this._initExtent(),L.setOptions(this,b)},onAdd:function(a){this._map=a,this._mapml||(this._mapml=d.mapMl(null,{opacity:this.options.opacity,onEachFeature:function(a,b){var c;c=b instanceof L.Polygon?"Polygon":b instanceof L.Polyline?"LineString":b instanceof L.Marker?"Point":"Unknown";for(var d="<p>Type: "+c+"</p>",e=a.children,f=0;f<e.length;f++)d+=e[f].tagName+" = "+e[f].innerHTML+"<br>";b.bindPopup(d,{autoPan:!1})}})),a.addLayer(this._mapml),this._imageLayer||(this._imageLayer=L.layerGroup()),a.addLayer(this._imageLayer),this._tileLayer||(this._tileLayer=d.mapMLTileLayer(this.href?this.href:this._href,this.options)),this._el||(this._el=this._tileLayer._el=L.DomUtil.create("div","mapml-layer leaflet-zoom-hide")),a.addLayer(this._tileLayer),this._tileLayer._container.appendChild(this._el),this._extent&&this._onMoveEnd()},addTo:function(a){return a.addLayer(this),this},getEvents:function(){return{zoom:this._reset,moveend:this._onMoveEnd}},onRemove:function(a){this._mapml.clearLayers(),a.removeLayer(this._mapml),a.removeLayer(this._tileLayer),a.removeLayer(this._imageLayer)},getZoomBounds:function(){if(this._extent){var a={},b=this._extent.querySelector("[type=zoom]").getAttribute("min"),c=this._extent.querySelector("[type=zoom]").getAttribute("max");return a.min=Math.min(b,c),a.max=Math.max(b,c),a}},getLayerExtentBounds:function(a){var b,c,e,f,g,h,i,j,k,l=a.getZoom(),m=a.options.projection,n=m!==this._extent.querySelector("[type=projection]").getAttribute("value");if(this._extent)return h=this._extent.querySelector("[type=xmin]").getAttribute("min"),i=this._extent.querySelector("[type=xmax]").getAttribute("min"),c=Math.min(h,i),h=this._extent.querySelector("[type=xmin]").getAttribute("max"),i=this._extent.querySelector("[type=xmax]").getAttribute("max"),f=Math.max(h,i),h=this._extent.querySelector("[type=ymin]").getAttribute("min"),i=this._extent.querySelector("[type=ymax]").getAttribute("min"),e=Math.min(h,i),h=this._extent.querySelector("[type=ymin]").getAttribute("max"),i=this._extent.querySelector("[type=ymax]").getAttribute("max"),g=Math.max(h,i),j=parseInt(this._extent.querySelector("[type=zoom]").getAttribute("value")),n?(k=d[m],b=[k.latLngToPoint(L.latLng([e,c]),l),k.latLngToPoint(L.latLng([g,f]),l),k.latLngToPoint(L.latLng([e,c]),l),k.latLngToPoint(L.latLng([e,f]),l)],L.bounds(b)):j!==l?(k=d[m],L.bounds(k.latLngToPoint(k.pointToLatLng(L.point(c,e),j),l),k.latLngToPoint(k.pointToLatLng(L.point(f,g),j),l))):L.bounds(L.point(c,e),L.point(f,g))},getAttribution:function(){return this.options.attribution},setZIndex:function(a){return this.options.zIndex=a,this._updateZIndex(),this},_updateZIndex:function(){this._container&&this.options.zIndex!==c&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},_initExtent:function(){function a(a,b){e.onreadystatechange=function(){if(this.readyState===this.DONE){if(200===this.status&&this.callback)return void this.callback.apply(this,this.arguments);406===this.status&&null!==this.response&&this.responseXML.querySelector("error")&&(console.error("406"),e.abort())}},e.arguments=Array.prototype.slice.call(arguments,2),e.onload=b,e.onerror=function(){console.error(this.statusText)},e.open("GET",a),e.setRequestHeader("Accept",d.mime),e.overrideMimeType("text/xml"),e.send()}function b(){if(this.responseXML){var a=this.responseXML,b=a.getElementsByTagName("extent")[0],d=a.querySelectorAll("link[rel=license]")[0],e=d.getAttribute("title"),f=d.getAttribute("href"),g='<a href="'+f+'" title="'+e+'">'+e+"</a>";L.setOptions(c,{projection:a.querySelectorAll("input[type=projection]")[0].getAttribute("value"),attribution:g}),c._extent=b,c._map&&(c._map.hasLayer(c)&&c._map.attributionControl.addAttribution(c.getAttribution()),c._map.fire("moveend",c))}}if(this._href){var c=this,e=new XMLHttpRequest;a(this._href,b)}},_getMapML:function(a){function c(a,b){k.onreadystatechange=function(){if(this.readyState===this.DONE){if(200===this.status&&this.callback)return void this.callback.apply(this,this.arguments);406===this.status&&null!==this.response&&this.responseXML.querySelector("error")&&(console.error("406"),k.abort())}},k.arguments=Array.prototype.slice.call(arguments,2),k.onload=b,k.onerror=function(){console.error(this.statusText)},k.open("GET",a),k.setRequestHeader("Accept",d.mime+";projection="+h.options.projection+";zoom="+h.zoom),k.overrideMimeType("text/xml"),k.send()}function e(){var a,i,k,l;if(this.responseXML){if(0===j&&(i=this.responseXML.getElementsByTagName("extent")[0],h._extent=i,h._el.appendChild(b.importNode(i,!0))),this.responseXML.getElementsByTagName("feature").length>0&&h._mapml.addData(this.responseXML),this.responseXML.getElementsByTagName("tile").length>0){for(k=b.createElement("tiles"),l=this.responseXML.getElementsByTagName("tile"),a=0;a<l.length;a++)k.appendChild(b.importNode(l[a],!0));h._el.appendChild(k)}if(this.responseXML.getElementsByTagName("image").length>0){var m=this.responseXML.getElementsByTagName("image"),n=[],o=h._el.parentElement;for(a=0;a<m.length;a++){var p=m[a],q=p.getAttribute("src"),r=h._map,s=r.getPixelBounds().min.subtract(r.getPixelOrigin()),t=r.getSize();n[a]=d.imageOverlay(q,s,t,0,o)}var u=h._imageLayer.getLayers();for(a=0,last=n.length-1;a<n.length;a++)h._imageLayer.addLayer(n[a]),a===last&&n[a].on("load",f(h,u))}var v=g("next",this.responseXML);v&&j<h.options.maxNext?(j++,c(v,e)):h._el.getElementsByTagName("tile").length>0&&h._tileLayer._onMoveEnd()}}function f(a,b){for(i=0;i<b.length;i++)a._imageLayer.removeLayer(b[i])}function g(a,b){var c=b.querySelector("base"),d=c?c.getAttribute("href"):null,e=new URI(d||b.baseURI),f=b.querySelector("link[rel="+a+"]"),g=f?new URI(f.getAttribute("href")).resolve(e):null;return g}var h=this,j=0,k=new XMLHttpRequest;this._map.once("movestart",function(){k.abort()}),c(a,e)},_onMoveEnd:function(){var a=this._calculateUrl();a&&(this.href=a,this._mapml.clearLayers(),this._initEl(),this._getMapML(a))},_initEl:function(){if(this._el)for(var a=this._el;a.firstChild;)a.removeChild(a.firstChild)},_reset:function(){this._initEl(),this._mapml.clearLayers()},_getUnprojectedMapLatLngBounds:function(a){a=a||this._map;var b=a.getPixelOrigin(),c=a.getPixelBounds(),d=a.unproject(b),e=a.unproject(c.getBottomLeft()),f=a.unproject(c.getTopRight()),g=a.unproject(b.add(a.getSize()));return L.latLngBounds(e,f).extend(g).extend(d)},_calculateUrl:function(){if(!this._el&&!this._extent)return this._href;var a=this._el.getElementsByTagName("extent")[0]||this._extent;if(!a)return this._href;var b=a.getAttribute("action");if(!b)return null;var c,d=a.querySelectorAll("input[type=projection]")[0],e=d.getAttribute("value");c="WGS84"===e?this._getUnprojectedMapLatLngBounds():this._map.getPixelBounds();var f=a.querySelectorAll("input[type=xmin]")[0],g=a.querySelectorAll("input[type=ymin]")[0],h=a.querySelectorAll("input[type=xmax]")[0],i=a.querySelectorAll("input[type=ymax]")[0];if(!(f&&g&&h&&i))return null;var j=f.getAttribute("name")?f.getAttribute("name").trim():"xmin",k=g.getAttribute("name")?g.getAttribute("name").trim():"ymin",l=h.getAttribute("name")?h.getAttribute("name").trim():"xmax",m=i.getAttribute("name")?i.getAttribute("name").trim():"ymax",n="";n+=j+"={"+j+"}&",n+=k+"={"+k+"}&",n+=l+"={"+l+"}&",n+=m+"={"+m+"}";var o=a.querySelectorAll("input[type=zoom]")[0];if(!o||!d)return null;var p=parseInt(o.getAttribute("min")),q=parseInt(o.getAttribute("max")),r={},s=this._map.getZoom();if(!(s>=p&&q>=s))return null;r.zoom=s;var t=o.getAttribute("name")?o.getAttribute("name").trim():"zoom",u=t+"={"+t+"}";r.xmin=c.min?c.min.x:c.getWest(),r.ymin=c.min?c.min.y:c.getSouth(),r.xmax=c.max?c.max.x:c.getEast(),r.ymax=c.max?c.max.y:c.getNorth(),r.projection=e;var v=d.getAttribute("name")?d.getAttribute("name").trim():"projection",w=v+"={"+v+"}",x=n+"&"+u+"&"+w;return b+=(-1===b.search(/\?/g)?"?":"&")+x,L.Util.template(b,r)},_projectionMatches:function(a){return a=a||this._map,a.options.projection&&("WGS84"===this.options.projection||a.options.projection===this.options.projection)}}),d.mapMLLayer=function(a,b){return new d.MapMLLayer(a,b)},d.MapMLTileLayer=L.TileLayer.extend({getEvents:function(){var a={viewreset:this._resetAll,zoom:this._resetView,moveend:this._onMoveEnd};return this._zoomAnimated&&(a.zoomanim=this._animateZoom),a},_onMoveEnd:function(){this._map&&(this._update(),this._pruneTiles())},_update:function(){if(this._map){map=this._map;var a=map.getZoom();if(!(a>this.options.maxZoom||a<this.options.minZoom)){var b=this._groupTiles(this._el.getElementsByTagName("tile"));b.length&&this._addTiles(b)}}},_groupTiles:function(a){function b(a,b){var c,d={};return a.forEach(function(a){c=JSON.stringify(b(a)),d[c]=d[c]||[],d[c].push(a)}),Object.keys(d).map(function(a){return d[a]})}for(var c=[],d=0;d<a.length;d++){var e={};e.row=parseInt(a[d].getAttribute("row")),e.col=parseInt(a[d].getAttribute("col")),e.src=a[d].getAttribute("src"),c.push(e)}return b(c,function(a){return[a.row,a.col]})},_addTiles:function(a){for(var c=[],d={},e=0;e<a.length;e++)d.col=a[e][0].col,d.row=a[e][0].row,this._isValidTile(new L.Point(d.col,d.row))&&c.push(a[e]);var f=c.length;if(0!==f){var g=b.createDocumentFragment();for(this._loading||(this._loading=!0,this.fire("loading")),e=0;f>e;e++)this._addTile(c[e],g);this._level.el.appendChild(g)}},_addTile:function(a,c){var d,e,f,g,h=new L.Point(a[0].col,a[0].row),i=this._getTilePos(h);for(i.z=this._map.getZoom(),e=this._tileCoordsToKey(i),d=0;d<a.length;d++)f=this.createTile(a[d].src),this._initTile(f),setTimeout(L.bind(this._tileReady,this,i,null,f),0),a[d].img=f;if(this._tiles[e])g=this._tiles[e].el;else for(g=b.createElement("div"),d=0;d<a.length;d++)g.appendChild(a[d].img);L.DomUtil.setPosition(g,i),this._tiles[e]={el:g,coords:i,current:!0},c.appendChild(g),this.fire("tileloadstart",{tile:f,coords:i})},createTile:function(a){var c=b.createElement("img");return this.options.crossOrigin&&(c.crossOrigin=""),c.alt="",c.src=a,L.DomUtil.addClass(c,"leaflet-tile-loaded"),c},_abortLoading:function(){var a,b;for(a in this._tiles){tileDiv=this._tiles[a].el;var c=tileDiv.getElementsByTagName("img");for(a=0;a<c.length;a++)b=c[a],b.onload=L.Util.falseFn,b.onerror=L.Util.falseFn,b.complete||(b.src=L.Util.emptyImageUrl,L.DomUtil.remove(b))}}}),d.mapMLTileLayer=function(a,b){return new d.MapMLTileLayer(a,b)},d.MapML=L.FeatureGroup.extend({initialize:function(a,b){L.setOptions(this,b),this._layers={},a&&this.addData(a)},addData:function(a){var c,e,f,g,h,i,j,k,l=a.nodeType===Node.DOCUMENT_NODE?a.getElementsByTagName("feature"):null;if(k=a.nodeType===Node.DOCUMENT_NODE?a.querySelector("link[rel=stylesheet]"):null,k&&(e=a.querySelector("base"),c=new URI(e?e.getAttribute("href"):a.baseURI),h=new URI(k.getAttribute("href")),k=h.resolve(c).toString()),k&&(b.head.querySelector("link[href='"+k+"']")||(i=b.createElementNS("http://www.w3.org/1999/xhtml","link"),i.setAttribute("href",k),i.setAttribute("type","text/css"),i.setAttribute("rel","stylesheet"),b.head.appendChild(i))),l){for(f=0,g=l.length;g>f;f++){j=l[f];var m=j.getElementsByTagName("geometry").length&&j.getElementsByTagName("coordinates").length;m&&this.addData(j)}return this}var n=this.options;if(!n.filter||n.filter(a)){var o=d.MapML.geometryToLayer(a,n.pointToLayer,n.coordsToLatLng,n);return o.feature=a.getElementsByTagName("properties")[0],o.options.className=a.getAttribute("class")?a.getAttribute("class"):null,o.defaultOptions=o.options,this.resetStyle(o),n.onEachFeature&&n.onEachFeature(o.feature,o),this.addLayer(o)}},resetStyle:function(a){var b=this.options.style;b&&(L.Util.extend(a.options,a.defaultOptions),this._setLayerStyle(a,b))},setStyle:function(a){this.eachLayer(function(b){this._setLayerStyle(b,a)},this)},_setLayerStyle:function(a,b){"function"==typeof b&&(b=b(a.feature)),a.setStyle&&a.setStyle(b)}}),L.extend(d.MapML,{geometryToLayer:function(a,b,c,d){function e(a,b,c){var d=[];a.split(/\s+/gi).forEach(f,d),this.push(d)}function f(a,b,c){this.push(parseFloat(a))}var g,h,i,j="feature"===a.tagName?a.getElementsByTagName("geometry")[0]:a,k=j.getElementsByTagName("coordinates"),l=[];switch(c=c||this.coordsToLatLng,j.firstElementChild.tagName){case"Point":l=[],k[0].innerHTML.split(/\s+/gi).forEach(f,l),g=c(l);var m="scripts/lib/images/",n=d.opacity?d.opacity:null;return b?b(a,g):new L.Marker(g,{opacity:n,icon:L.icon({iconUrl:m+"marker-icon.png",iconRetinaUrl:m+"marker-icon-2x.png",shadowUrl:m+"marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]})});case"MultiPoint":throw new Error("Not implemented yet");case"LineString":return l=[],k[0].innerHTML.match(/(\S+ \S+)/gi).forEach(e,l),h=this.coordsToLatLngs(l,0,c),new L.Polyline(h,d);case"Polygon":for(l=new Array(k.length),i=0;i<k.length;i++)l[i]=[],k[i].innerHTML.match(/(\S+ \S+)/gi).forEach(e,l[i]);return h=this.coordsToLatLngs(l,1,c),new L.Polygon(h,d);case"MultiLineString":throw new Error("Not implemented yet");case"MultiPolygon":throw new Error("Not implemented yet");case"GeometryCollection":throw new Error("Not implemented yet");default:throw new Error("Invalid GeoJSON object.")}},coordsToLatLng:function(a){return new L.LatLng(a[1],a[0],a[2])},coordsToLatLngs:function(a,b,c){var d,e,f,g=[];for(e=0,f=a.length;f>e;e++)d=b?this.coordsToLatLngs(a[e],b-1,c):(c||this.coordsToLatLng)(a[e]),g.push(d);return g},latLngToCoords:function(a){var b=[a.lng,a.lat];return a.alt!==c&&b.push(a.alt),b},latLngsToCoords:function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(L.MapML.latLngToCoords(a[c]));return b}}),d.mapMl=function(a,b){return new d.MapML(a,b)},d.MapMLLayerControl=L.Control.Layers.extend({initialize:function(a,b){L.setOptions(this,b),this.options.collapsed=!1,this._layers={},this._lastZIndex=0,this._handlingClick=!1;for(var c in a)this._addLayer(a[c],c,!0)},onAdd:function(){return this._initLayout(),this._map.on("moveend",this._onMapMoveEnd,this),this._update(),this._map.fire("moveend",this),this._container},onRemove:function(a){a.off("moveend",this._onMapMoveEnd,this);for(var b in this._layers)this._layers[b].layer.off("add remove",this._onLayerChange,this)},_onMapMoveEnd:function(a){var b,c,d,e,f,g=this._map.getZoom(),h=this._map.getPixelBounds();for(c in this._layers)d=this._layers[c],d.layer._extent&&(b=d.layer.getZoomBounds(),f=d.layer._projectionMatches(this._map),e=f&&this._withinZoomBounds(g,b)&&h.intersects(d.layer.getLayerExtentBounds(this._map)),e?(d.input.disabled=!1,d.input.style=null,d.input.nextElementSibling.style.fontStyle=null):(d.input.disabled=!0,f||(this._map.removeLayer(d.layer),d.input.disabled=!0,d.input.checked=!1),d.input.nextElementSibling.style.fontStyle="italic"))},_withinZoomBounds:function(a,b){return b.min<=a&&a<=b.max},_addItem:function(a){var c,d=b.createElement("label"),e=this._map.hasLayer(a.layer);c=b.createElement("input"),c.type="checkbox",c.className="leaflet-control-layers-selector",c.defaultChecked=e,a.input=c,c.layerId=L.stamp(a.layer),L.DomEvent.on(c,"click",this._onInputClick,this);var f=b.createElement("span");f.innerHTML=" "+a.name,d.appendChild(c),d.appendChild(f);var g=this._overlaysList;return g.appendChild(d),d}}),d.mapMlLayerControl=function(a,b){return new d.MapMLLayerControl(a,b)}}(window,document);