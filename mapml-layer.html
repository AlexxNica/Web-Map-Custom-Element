<link rel="import" href="./bower_components/polymer/polymer.html">

<script src="scripts/lib/leaflet-src.js"></script>
<script src="scripts/lib/proj4-compressed.js"></script>
<script src="scripts/lib/proj4leaflet.js"></script>
<script src="scripts/mapml.js"></script>
<script src="scripts/URI.js"></script>

<dom-module id="mapml-layer">
  <!-- in polymer 1.0.x, styles must be outside of the <template> element
       https://www.polymer-project.org/1.0/docs/migration.html#local-dom-template -->
  <style>
   :host {
     display: none;
   }
  </style>

<script>
Polymer({
    is: "mapml-layer",
    extends: "source",
    properties: {
      src : {
        type: String,
        reflectToAttribute: true
      },
      label : {
        type: String,
        value: 'Layer',
        reflectToAttribute: true
      },
      checked: {
        type: Boolean,
        reflectToAttribute: true
      },
      disabled: {
        type: Boolean,
        reflectToAttribute: true
      },
      hidden: {
        type: Boolean,
        reflectToAttribute: true
      }
    },
//    observers: [
//        '_toggleChecked(checked)'
//    ],
    _toggleChecked: function(newValue) {
//        if (this.parentElement.map) {
//          if (this.parentElement.map.hasLayer(this._layer)) {
//            this.parentElement.map.removeLayer(this._layer);
//            this.checked = newValue;
//          } else {
//            this.parentElement.map.addLayer(this._layer);
//            this.checked = newValue;
//          }
//        }
        return;
    },
    // the onLayerChange method is set (by the map) to fire when the layer is 
    // added or removed from the map.  We can change the checked property to
    // reflect whether the layer is on the map or not, but we can't expose
    // write API to the checked attribute because if you set up an observer to
    // push that change to the map, because the layer change handler will trigger
    // the observer, which, in the case where the change was initiated by the user click
    // on the layer control, will reverse the change already effected by the
    // layer control.  So an infinite loop is set up and is only cancelled by
    // some javascript engine magic, I think.  So a solution might be for
    // the observer to suspend the layer change handler when it does the layer
    // change and for the layer change handler to suspend the observer when it
    // changes the value of the property, but so far it does not seem possible
    // to  suspend the observer.  I have asked on slack and #askpolymer, but
    // my reading of the documentation and googling the issue reveals that it is
    // not commonly done.
    _onLayerChange: function() {
       if (this._layer._map) {
          this.checked = this._layer._map.hasLayer(this._layer);
       }
    },
    ready: function() {
        console.log(this.localName + '#' + this.id + ' is ready');

        this._layer = M.mapMLLayer(this.src);

    }
});
</script>
</dom-module>
